name: Auto PR and Merge on Push
on:
  push:
    branches:
      - develop  # Remplacez par votre branche source

jobs:
  create-and-merge-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Étape 1: Création automatique de la PR
      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "Mise à jour automatique - $(date +'%Y-%m-%d %H:%M')"
          body: "PR automatique générée après commit"
          branch: ${{ github.ref_name }}  # Utilise la branche actuelle
          base: "main"  # Branche cible
          labels: "auto-generated"
          delete-branch: true  # Supprime la branche après merge
          
      # Étape 2: Fusion automatique si la PR a été créée
      - name: Auto Merge PR
        if: steps.create-pr.outputs.pull-request-number
        uses: actions/github-script@v6
        with:
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: ${{ steps.create-pr.outputs.pull-request-number }},
                merge_method: 'merge'  # ou 'squash'/'rebase'
              })
              console.log('PR merged successfully')
            } catch (error) {
              console.error('Merge failed:', error)
              // Gestion d'erreur optionnelle
            }